<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Therapy EMR/Billing Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #f0f0f0;
            padding: 30px;
        }
        
        .container {
            max-width: 1100px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .header {
            background: #4a90e2;
            color: white;
            padding: 20px 30px;
            border-radius: 8px 8px 0 0;
        }
        
        .header h1 {
            font-size: 24px;
        }
        
        .workflow-section {
            background: #fff3cd;
            border: 3px solid #ffc107;
            padding: 25px 30px;
            margin: 0;
        }
        
        .workflow-section h2 {
            color: #856404;
            font-size: 18px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .workflow-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-content {
            padding: 30px;
        }
        
        .section-header {
            font-size: 20px;
            color: #333;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 3px solid #4a90e2;
            font-weight: bold;
        }
        
        .subsection-header {
            font-size: 16px;
            color: #555;
            margin: 25px 0 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-left: 4px solid #4a90e2;
            font-weight: bold;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
            padding: 15px;
            border-radius: 5px;
            background: #fafafa;
        }
        
        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }
        
        .form-group input[type="text"],
        .form-group input[type="file"],
        .form-group input[type="date"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 5px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 4px;
        }
        
        .checkbox-item input[type="checkbox"],
        .checkbox-item input[type="radio"] {
            width: 20px;
            height: 20px;
        }
        
        .checkbox-item label {
            margin: 0;
            font-weight: normal;
        }
        
        .button-primary {
            background: #28a745;
            color: white;
            border: 3px solid #1e7e34;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .button-submit {
            background: #dc3545;
            color: white;
            border: 3px solid #bd2130;
            padding: 18px 50px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            display: block;
            margin: 30px auto 0;
        }
        
        .workflow-button-container {
            text-align: center;
        }

        .hint {
            margin-top: 8px;
            color: #666;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container" data-form-version="1.0.2">
        <div class="header">
            <h1>Therapy EMR/Billing Dashboard</h1>
        </div>
        <div class="workflow-section">
            <div class="workflow-button-container">
                <button type="button" id="start_workflow_button" class="button-primary" data-testid="start_workflow_button">
                    Start Auto-Fill Workflow
                </button>
            </div>
        </div>
        
        <div class="form-content">
            <h2 class="section-header">Claim Data Form (Automation Target)</h2>
            
            <div class="subsection-header">Patient & Session Information</div>
            <div class="form-row">
                <div class="form-group">
                    <label for="patient_search">Patient Name</label>
                    <input type="text" id="patient_search" placeholder="e.g., A.B. or John Doe" data-field="patient_search" data-section="patient_session" data-type="text" data-testid="patient_search">
                </div>
                <div class="form-group">
                    <label for="patient_id">Patient ID</label>
                    <input type="text" id="patient_id" placeholder="e.g., PT-2024-1001" required aria-required="true" data-field="patient_id" data-section="patient_session" data-type="text" data-testid="patient_id">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="session_date">Session Date</label>
                    <input type="date" id="session_date" placeholder="YYYY-MM-DD" required aria-required="true" data-field="session_date" data-section="patient_session" data-type="date" data-testid="session_date">
                </div>
                <div class="form-group">
                    <label for="provider_name">Clinician Name</label>
                    <input type="text" id="provider_name" placeholder="e.g., Jane Doe, MD" data-field="provider_name" data-section="patient_session" data-type="text" data-testid="provider_name">
                </div>
            </div>

            <div class="subsection-header">Clinical Progress Notes (SOAP)</div>
            <div class="form-group">
                <label for="subjective_note">S: Subjective Note</label>
                <textarea id="subjective_note" placeholder="Patient's reported feelings, symptoms, and concerns." data-field="subjective_note" data-section="soap" data-type="textarea" data-testid="subjective_note"></textarea>
            </div>
            <div class="form-group">
                <label for="objective_note">O: Objective Note</label>
                <textarea id="objective_note" placeholder="Clinician's observations, MSE findings, and objective measures." data-field="objective_note" data-section="soap" data-type="textarea" data-testid="objective_note"></textarea>
            </div>
            
            <div class="subsection-header">Diagnosis & Procedure Codes</div>
            <div class="form-row">
                <div class="form-group">
                    <label for="primary_icd10">Primary Diagnosis (ICD-10)</label>
                    <input type="text" id="primary_icd10" placeholder="e.g., F25.1" required aria-required="true" data-field="primary_icd10" data-section="codes" data-type="text" data-testid="primary_icd10">
                </div>
                
                <div class="form-group">
                    <label for="cpt_code">CPT Procedure Code</label>
                    <input type="text" id="cpt_code" placeholder="e.g., 90834" required aria-required="true" data-field="cpt_code" data-section="codes" data-type="text" data-testid="cpt_code">
                </div>
            </div>
            
            <div class="subsection-header">Mental Status Exam & Status</div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="orientation_field">Orientation</label>
                    <select id="orientation_field" data-field="orientation_field" data-section="mse" data-type="select" data-testid="orientation_field">
                        <option value="">Select Orientation</option>
                        <option value="x3">X3: Oriented to Person, Place, and Time</option>
                        <option value="x2_pp">X2: Oriented to Person, Place; Impaired to Time</option>
                        <option value="x2_pt">X2: Oriented to Person, Time; Impaired to Place</option>
                        <option value="x2_tp">X2: Oriented to Time, Place; Impaired to Person</option>
                        <option value="x1_p">X1: Oriented to Person; Impaired to Place, Time</option>
                        <option value="x1_pl">X1: Oriented to Place; Impaired to Person, Time</option>
                        <option value="x1_t">X1: Oriented to Time; Impaired to Person, Place</option>
                        <option value="x0">X0: Impaired to Person, Place, and Time</option>
                        <option value="not_assessed">Not Assessed</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="general_appearance_field">General Appearance</label>
                    <input type="text" id="general_appearance_field" placeholder="Describe general appearance" data-field="general_appearance_field" data-section="mse" data-type="text" data-testid="general_appearance_field">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="dress_field">Dress</label>
                    <select id="dress_field" data-field="dress_field" data-section="mse" data-type="select" data-testid="dress_field">
                        <option value="">Select Dress</option>
                        <option value="appropriate">Appropriate</option>
                        <option value="disheveled">Disheveled</option>
                        <option value="emaciated">Emaciated</option>
                        <option value="obese">Obese</option>
                        <option value="poor_hygiene">Poor Hygiene</option>
                        <option value="not_assessed">Not Assessed</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="motor_activity_field">Motor Activity</label>
                    <select id="motor_activity_field" data-field="motor_activity_field" data-section="mse" data-type="select" data-testid="motor_activity_field">
                        <option value="">Select Motor Activity</option>
                        <option value="appropriate">Appropriate</option>
                        <option value="unremarkable">Unremarkable</option>
                        <option value="agitation">Agitation</option>
                        <option value="retardation">Retardation</option>
                        <option value="posturing">Posturing</option>
                        <option value="repetitive">Repetitive Actions</option>
                        <option value="tics">Tics</option>
                        <option value="tremor">Tremor</option>
                        <option value="unusual_gait">Unusual Gait</option>
                        <option value="eccentric">Eccentric</option>
                        <option value="seductive">Seductive</option>
                        <option value="bizarre">Bizarre</option>
                        <option value="not_assessed">Not Assessed</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="interview_behavior_field">Interview Behavior</label>
                    <select id="interview_behavior_field" data-field="interview_behavior_field" data-section="mse" data-type="select" data-testid="interview_behavior_field">
                        <option value="">Select Interview Behavior</option>
                        <option value="appropriate">Appropriate</option>
                        <option value="aggressive">Aggressive</option>
                        <option value="angry">Angry</option>
                        <option value="apathetic">Apathetic</option>
                        <option value="argumentative">Argumentative</option>
                        <option value="child_like">Child-like</option>
                        <option value="demanding">Demanding</option>
                        <option value="drastic">Drastic</option>
                        <option value="evasive">Evasive</option>
                        <option value="hostile">Hostile</option>
                        <option value="irritable">Irritable</option>
                        <option value="passive">Passive</option>
                        <option value="manipulative">Manipulative</option>
                        <option value="withdrawn">Withdrawn</option>
                        <option value="uncooperative">Uncooperative</option>
                        <option value="not_assessed">Not Assessed</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="speech_field">Speech</label>
                    <select id="speech_field" data-field="speech_field" data-section="mse" data-type="select" data-testid="speech_field">
                        <option value="">Select Speech</option>
                        <option value="normal">Normal</option>
                        <option value="hesitant">Hesitant</option>
                        <option value="pressured">Pressured</option>
                        <option value="slurred">Slurred</option>
                        <option value="soft">Soft</option>
                        <option value="stuttering">Stuttering</option>
                        <option value="mute">Mute</option>
                        <option value="verbose">Verbose</option>
                        <option value="not_assessed">Not Assessed</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="mood_field">Mood</label>
                    <select id="mood_field" data-field="mood_field" data-section="mse" data-type="select" data-testid="mood_field">
                        <option value="">Select Mood</option>
                        <option value="Depressed">Depressed</option>
                        <option value="sad">Sad</option>
                        <option value="elevated">Elevated</option>
                        <option value="euthymic">Euthymic</option>
                        <option value="anhedonic">Anhedonic</option>
                        <option value="dysphoric">Dysphoric</option>
                        <option value="euphoric">Euphoric</option>
                        <option value="grandiose">Grandiose</option>
                        <option value="anxious">Anxious</option>
                        <option value="labile">Labile</option>
                        <option value="irritable">Irritable</option>
                        <option value="angry">Angry</option>
                        <option value="not_assessed">Not Assessed</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="affect_field">Affect</label>
                    <select id="affect_field" data-field="affect_field" data-section="mse" data-type="select" data-testid="affect_field">
                        <option value="">Select Affect</option>
                        <option value="Constricted">Constricted</option>
                        <option value="dysphoric">Dysphoric</option>
                        <option value="flat">Flat</option>
                        <option value="restricted">Restricted</option>
                        <option value="appropriate">Appropriate</option>
                        <option value="congruent">Congruent</option>
                        <option value="incongruent">Incongruent</option>
                        <option value="inappropriate">Inappropriate</option>
                        <option value="reactive">Reactive</option>
                        <option value="blunted">Blunted</option>
                        <option value="not_assessed">Not Assessed</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="insight_field">Insight</label>
                    <select id="insight_field" data-field="insight_field" data-section="mse" data-type="select" data-testid="insight_field">
                        <option value="">Select Insight</option>
                        <option value="excellent">Excellent</option>
                        <option value="good">Good</option>
                        <option value="fair">Fair</option>
                        <option value="poor">Poor</option>
                        <option value="limited">Limited</option>
                        <option value="nil">Nil</option>
                        <option value="not_assessed">Not Assessed</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="judgment_field">Judgment/Impulse Control</label>
                    <select id="judgment_field" data-field="judgment_field" data-section="mse" data-type="select" data-testid="judgment_field">
                        <option value="">Select Judgment</option>
                        <option value="excellent">Excellent</option>
                        <option value="good">Good</option>
                        <option value="fair">Fair</option>
                        <option value="poor">Poor</option>
                        <option value="nil">Nil</option>
                        <option value="not_assessed">Not Assessed</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="memory_field">Memory</label>
                    <input type="text" id="memory_field" placeholder="Describe memory assessment" data-field="memory_field" data-section="mse" data-type="text" data-testid="memory_field">
                </div>
                
                <div class="form-group">
                    <label for="attention_field">Attention/Concentration</label>
                    <select id="attention_field" data-field="attention_field" data-section="mse" data-type="select" data-testid="attention_field">
                        <option value="">Select Attention/Concentration</option>
                        <option value="intact">Intact</option>
                        <option value="poor_remote">Poor Remote</option>
                        <option value="poor_recent">Poor Recent</option>
                        <option value="not_assessed">Not Assessed</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="thought_process_field">Thought Process</label>
                    <select id="thought_process_field" data-field="thought_process_field" data-section="mse" data-type="select" data-testid="thought_process_field">
                        <option value="">Select Thought Process</option>
                        <option value="good">Good</option>
                        <option value="distractible">Distractible</option>
                        <option value="variable">Variable</option>
                        <option value="unremarkable">Unremarkable</option>
                        <option value="blocking">Blocking</option>
                        <option value="circumstantial">Circumstantial</option>
                        <option value="flight_of_ideas">Flight of Ideas</option>
                        <option value="loose_associations">Loose Associations</option>
                        <option value="perseveration">Perseveration</option>
                        <option value="tangential">Tangential</option>
                        <option value="not_assessed">Not Assessed</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="thought_content_field">Thought Content</label>
                    <select id="thought_content_field" data-field="thought_content_field" data-section="mse" data-type="select" data-testid="thought_content_field">
                        <option value="">Select Thought Content</option>
                        <option value="appropriate">Appropriate</option>
                        <option value="preoccupied">Preoccupied</option>
                        <option value="obsessions">Obsessions</option>
                        <option value="delusions_persecutory">Delusions: Persecutory</option>
                        <option value="delusions_bizarre">Delusions: Bizarre</option>
                        <option value="delusions_grandeur">Delusions: Grandeur</option>
                        <option value="delusions_guilt">Delusions: Guilt</option>
                        <option value="delusions_somatic">Delusions: Somatic</option>
                        <option value="delusions_ideas_of_reference">Delusions: Ideas of Reference</option>
                        <option value="delusions_thought_broadcasting">Delusions: Thought Broadcasting</option>
                        <option value="delusions_thought_control">Delusions: Thought Control</option>
                        <option value="not_assessed">Not Assessed</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="functional_status_field">Functional Status</label>
                    <select id="functional_status_field" data-field="functional_status_field" data-section="mse" data-type="select" data-testid="functional_status_field">
                        <option value="">Select Functional Status</option>
                        <option value="intact">Intact</option>
                        <option value="Mildly Impaired">Mildly Impaired</option>
                        <option value="Moderately Impaired">Moderately Impaired</option>
                        <option value="Severely Impaired">Severely Impaired</option>
                        <option value="variably_impaired">Variably Impaired</option>
                        <option value="Not Assessed">Not Assessed</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="perception_field">Perception Disturbances</label>
                    <select id="perception_field" data-field="perception_field" data-section="mse" data-type="select" data-testid="perception_field">
                        <option value="">Select Perception Status</option>
                        <option value="unremarkable">Unremarkable</option>
                        <option value="Auditory Hallucinations">Auditory Hallucinations</option>
                        <option value="Visual Hallucinations">Visual Hallucinations</option>
                        <option value="olfactory_hallucinations">Olfactory Hallucinations</option>
                        <option value="tactile_hallucinations">Tactile Hallucinations</option>
                        <option value="gustatory_hallucinations">Gustatory Hallucinations</option>
                        <option value="None">None</option>
                        <option value="not_assessed">Not Assessed</option>
                    </select>
                </div>
            </div>
            
            <div class="subsection-header">Risk Assessment & Justification</div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Area of Risk</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="area_of_risk_suicidality" data-field="area_of_risk_suicidality" data-section="risk" data-type="checkbox" data-testid="area_of_risk_suicidality">
                            <label for="area_of_risk_suicidality">Suicidality</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="area_of_risk_homicidality" data-field="area_of_risk_homicidality" data-section="risk" data-type="checkbox" data-testid="area_of_risk_homicidality">
                            <label for="area_of_risk_homicidality">Homicidality</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Risk Level</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="radio" name="risk_level" id="risk_level_low" value="low" data-field="risk_level" data-section="risk" data-type="radio" data-testid="risk_level_low">
                            <label for="risk_level_low">Low</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="radio" name="risk_level" id="risk_level_medium" value="medium" data-field="risk_level" data-section="risk" data-type="radio" data-testid="risk_level_medium">
                            <label for="risk_level_medium">Medium</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="radio" name="risk_level" id="risk_level_high" value="high" data-field="risk_level" data-section="risk" data-type="radio" data-testid="risk_level_high">
                            <label for="risk_level_high">High</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="risk_factors">Risk Factors/Management Plan</label>
                <textarea id="risk_factors" placeholder="e.g., Passive SI present, no plan/intent. Interventions: safety planning, weekly check-ins." data-field="risk_factors" data-section="risk" data-type="textarea" data-testid="risk_factors"></textarea>
            </div>
            
            <div class="subsection-header">Insurance Details</div>
            <div class="form-group">
                <label for="insurance_card_upload">Upload Insurance Card</label>
                <input type="file" id="insurance_card_upload" accept=".jpg,.jpeg,.png,.pdf" data-field="insurance_card_upload" data-section="insurance" data-type="file" data-testid="insurance_card_upload">
                <div class="hint">Or provide a file URL (for automation):</div>
                <input type="text" id="insurance_card_url" placeholder="https://example.com/insurance.jpg" data-field="insurance_card_url" data-section="insurance" data-type="url" data-testid="insurance_card_url">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="policy_id">Insurance Policy Number</label>
                    <input type="text" id="policy_id" placeholder="e.g., ABC4567890" data-field="policy_id" data-section="insurance" data-type="text" data-testid="policy_id">
                </div>
                
                <div class="form-group">
                    <label for="group_id">Insurance Group ID</label>
                    <input type="text" id="group_id" placeholder="e.g., GRP-3025-A" data-field="group_id" data-section="insurance" data-type="text" data-testid="group_id">
                </div>
            </div>
            
            <div class="subsection-header">Clinical Signature & Approval</div>
            <div class="form-group">
                <label for="clinician_signature">Clinician Signature (Electronic Approval)</label>
                <input type="text" id="clinician_signature" placeholder="Type full name to sign" data-field="clinician_signature" data-section="finalization" data-type="text" data-testid="clinician_signature">
            </div>
            <div class="form-group">
                <label for="digital_signature">Digital Signature</label>
                <canvas id="digital_signature" width="600" height="150" style="border: 2px solid #ccc; background: #fff; display: block; width: 100%; max-width: 100%;"></canvas>
                <button type="button" id="clear_signature" class="button-primary" style="margin-top: 10px; background: #6c757d; border-color: #545b62;" data-testid="clear_signature">Clear Signature</button>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button type="button" id="submit_documentation" class="button-submit" data-testid="submit_documentation" style="display: inline-block; margin: 0 10px;">
                    Save & Submit Documentation
                </button>
                <button type="button" id="download_pdf" class="button-submit" data-testid="download_pdf" style="display: inline-block; margin: 0 10px; background: #007bff; border-color: #0056b3;">
                    Download as PDF
                </button>
            </div>
        </div>
    </div>

    <!-- Machine-readable EMR Schema Manifest -->
    <script type="application/json" id="emr-manifest">
    {
        "name": "therapy-emr-claim",
        "version": "1.0.2",
        "fields": [
            { "id": "audio_upload_input", "type": "file", "selector": "#audio_upload_input", "required": false },
            { "id": "audio_upload_url", "type": "url", "selector": "#audio_upload_url", "required": false },
            { "id": "note_upload_input", "type": "file", "selector": "#note_upload_input", "required": false },
            { "id": "note_upload_url", "type": "url", "selector": "#note_upload_url", "required": false },

            { "id": "patient_search", "type": "text", "selector": "#patient_search", "required": false },
            { "id": "session_date", "type": "date", "selector": "#session_date", "required": true },
            { "id": "patient_id", "type": "text", "selector": "#patient_id", "required": true },

            { "id": "subjective_note", "type": "textarea", "selector": "#subjective_note", "required": false },
            { "id": "objective_note", "type": "textarea", "selector": "#objective_note", "required": false },

            { "id": "primary_icd10", "type": "text", "selector": "#primary_icd10", "required": true },
            { "id": "cpt_code", "type": "text", "selector": "#cpt_code", "required": true },

            { "id": "orientation_field", "type": "select", "selector": "#orientation_field", "required": false },
            { "id": "general_appearance_field", "type": "text", "selector": "#general_appearance_field", "required": false },
            { "id": "dress_field", "type": "select", "selector": "#dress_field", "required": false },
            { "id": "motor_activity_field", "type": "select", "selector": "#motor_activity_field", "required": false },
            { "id": "interview_behavior_field", "type": "select", "selector": "#interview_behavior_field", "required": false },
            { "id": "speech_field", "type": "select", "selector": "#speech_field", "required": false },
            { "id": "mood_field", "type": "select", "selector": "#mood_field", "required": false },
            { "id": "affect_field", "type": "select", "selector": "#affect_field", "required": false },
            { "id": "insight_field", "type": "select", "selector": "#insight_field", "required": false },
            { "id": "judgment_field", "type": "select", "selector": "#judgment_field", "required": false },
            { "id": "memory_field", "type": "text", "selector": "#memory_field", "required": false },
            { "id": "attention_field", "type": "select", "selector": "#attention_field", "required": false },
            { "id": "thought_process_field", "type": "select", "selector": "#thought_process_field", "required": false },
            { "id": "thought_content_field", "type": "select", "selector": "#thought_content_field", "required": false },
            { "id": "functional_status_field", "type": "select", "selector": "#functional_status_field", "required": false },
            { "id": "perception_field", "type": "select", "selector": "#perception_field", "required": false },

            { "id": "area_of_risk_suicidality", "type": "checkbox", "selector": "#area_of_risk_suicidality", "required": false },
            { "id": "area_of_risk_homicidality", "type": "checkbox", "selector": "#area_of_risk_homicidality", "required": false },
            { "id": "risk_level", "type": "radio", "selector": "input[name='risk_level']", "required": false, "options": ["low","medium","high"] },
            { "id": "risk_factors", "type": "textarea", "selector": "#risk_factors", "required": false },

            { "id": "insurance_card_upload", "type": "file", "selector": "#insurance_card_upload", "required": false },
            { "id": "insurance_card_url", "type": "url", "selector": "#insurance_card_url", "required": false },
            { "id": "policy_id", "type": "text", "selector": "#policy_id", "required": false },
            { "id": "group_id", "type": "text", "selector": "#group_id", "required": false },

            { "id": "provider_name", "type": "text", "selector": "#provider_name", "required": false },
            { "id": "clinician_signature", "type": "text", "selector": "#clinician_signature", "required": false },
            { "id": "digital_signature", "type": "signature", "selector": "#digital_signature", "required": false },

            { "id": "start_workflow_button", "type": "button", "selector": "#start_workflow_button", "required": false },
            { "id": "submit_documentation", "type": "button", "selector": "#submit_documentation", "required": false },
            { "id": "download_pdf", "type": "button", "selector": "#download_pdf", "required": false }
        ]
    }
    </script>

    <!-- Automation Bridge -->
    <script>
    (function () {
        // Signature pad functionality
        let isDrawing = false;
        let signatureData = '';
        
        function setupSignaturePad() {
            const canvas = document.getElementById('digital_signature');
            const clearBtn = document.getElementById('clear_signature');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            
            function getMousePos(e) {
                const rect = canvas.getBoundingClientRect();
                return {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
            }
            
            function getTouchPos(e) {
                const rect = canvas.getBoundingClientRect();
                return {
                    x: e.touches[0].clientX - rect.left,
                    y: e.touches[0].clientY - rect.top
                };
            }
            
            // Mouse events
            canvas.addEventListener('mousedown', (e) => {
                isDrawing = true;
                const pos = getMousePos(e);
                ctx.beginPath();
                ctx.moveTo(pos.x, pos.y);
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (!isDrawing) return;
                const pos = getMousePos(e);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
                signatureData = canvas.toDataURL();
            });
            
            canvas.addEventListener('mouseup', () => {
                isDrawing = false;
            });
            
            // Touch events
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                isDrawing = true;
                const pos = getTouchPos(e);
                ctx.beginPath();
                ctx.moveTo(pos.x, pos.y);
            });
            
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (!isDrawing) return;
                const pos = getTouchPos(e);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
                signatureData = canvas.toDataURL();
            });
            
            canvas.addEventListener('touchend', (e) => {
                e.preventDefault();
                isDrawing = false;
            });
            
            // Clear button
            if (clearBtn) {
                clearBtn.addEventListener('click', () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    signatureData = '';
                });
            }
        }
        
        // Initialize signature pad when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupSignaturePad);
        } else {
            setupSignaturePad();
        }

        const manifestEl = document.getElementById('emr-manifest');
        const manifest = manifestEl ? JSON.parse(manifestEl.textContent) : { name: 'therapy-emr-claim', version: '1.0.2', fields: [] };

        function getFieldDefById(fieldId) {
            return manifest.fields.find(f => f.id === fieldId);
        }

        function qs(selector) {
            return document.querySelector(selector);
        }

        function qsa(selector) {
            return Array.from(document.querySelectorAll(selector));
        }

        function getSchema() {
            return manifest;
        }

        function getValues() {
            const values = {};
            manifest.fields.forEach(f => {
                const type = f.type;
                if (type === 'radio' && (f.selector.includes('risk_level') || f.selector.includes('location'))) {
                    const fieldName = f.selector.includes('risk_level') ? 'risk_level' : 'location';
                    const checked = qs(`input[name='${fieldName}']:checked`);
                    values[f.id] = checked ? checked.value : null;
                    return;
                }
                if (type === 'signature') {
                    values[f.id] = signatureData || '';
                    return;
                }
                const el = qs(f.selector);
                if (!el) return;

                if (type === 'checkbox') {
                    values[f.id] = !!el.checked;
                } else if (type === 'file') {
                    values[f.id] = el.files && el.files.length > 0 ? { hasFile: true, count: el.files.length } : { hasFile: false };
                } else if (type === 'textarea' || type === 'text' || type === 'date' || type === 'url' || type === 'select') {
                    values[f.id] = el.value ?? '';
                } else if (type === 'button') {
                    // no value
                }
            });
            return values;
        }

        function setValues(partial) {
            if (!partial || typeof partial !== 'object') return;

            Object.entries(partial).forEach(([id, val]) => {
                const def = getFieldDefById(id);
                if (!def) return;

                if (def.type === 'radio' && (def.selector.includes('risk_level') || def.selector.includes('location'))) {
                    const fieldName = def.selector.includes('risk_level') ? 'risk_level' : 'location';
                    const tgt = qs(`input[name='${fieldName}'][value='${String(val)}']`);
                    if (tgt) {
                        tgt.checked = true;
                        tgt.dispatchEvent(new Event('input', { bubbles: true }));
                        tgt.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                    return;
                }

                if (def.type === 'signature') {
                    // Cannot programmatically set signature, but we can store the data
                    signatureData = val || '';
                    return;
                }

                const el = qs(def.selector);
                if (!el) return;

                if (def.type === 'checkbox') {
                    el.checked = !!val;
                } else if (def.type === 'select') {
                    el.value = String(val);
                } else if (def.type === 'file') {
                    // Cannot programmatically set file inputs
                } else if (def.type === 'button') {
                    // ignore
                } else {
                    el.value = val == null ? '' : String(val);
                }

                if (def.type !== 'button' && def.type !== 'signature') {
                    el.dispatchEvent(new Event('input', { bubbles: true }));
                    el.dispatchEvent(new Event('change', { bubbles: true }));
                }
            });
        }

        function click(selectorOrId) {
            const selector = selectorOrId.startsWith('#') ? selectorOrId : `#${selectorOrId}`;
            const el = qs(selector);
            if (el) el.click();
        }

        function validate() {
            const errors = [];
            manifest.fields.forEach(f => {
                if (!f.required) return;

                if (f.type === 'radio' && (f.selector.includes('risk_level') || f.selector.includes('location'))) {
                    const fieldName = f.selector.includes('risk_level') ? 'risk_level' : 'location';
                    const checked = qs(`input[name='${fieldName}']:checked`);
                    if (!checked) errors.push({ id: f.id, message: 'Required' });
                    return;
                }

                const el = qs(f.selector);
                if (!el) {
                    errors.push({ id: f.id, message: 'Field not found' });
                    return;
                }
                const raw = (el.value ?? '').toString().trim();
                if (raw.length === 0) {
                    errors.push({ id: f.id, message: 'Required' });
                }
            });
            return { ok: errors.length === 0, errors };
        }

        function emit(name, detail) {
            document.dispatchEvent(new CustomEvent(name, { detail }));
        }

        // Wire field change listeners to emit events
        manifest.fields.forEach(f => {
            const els = (f.type === 'radio') ? qsa(f.selector) : [qs(f.selector)];
            els.filter(Boolean).forEach(el => {
                el.addEventListener('change', () => {
                    const allValues = getValues();
                    emit('emr:fieldChanged', { id: f.id, value: allValues[f.id] });
                });
            });
        });

        // Buttons
        const startBtn = qs('#start_workflow_button');
        if (startBtn) {
            startBtn.addEventListener('click', () => {
                emit('emr:start', { values: getValues() });
                try {
                    window.postMessage({ namespace: 'emr', type: 'start', payload: { values: getValues() } }, '*');
                } catch (e) {}
            });
        }

        const submitBtn = qs('#submit_documentation');
        if (submitBtn) {
            submitBtn.addEventListener('click', () => {
                const result = validate();
                if (!result.ok) {
                    emit('emr:validationFailed', result);
                    try {
                        window.postMessage({ namespace: 'emr', type: 'validation', payload: result }, '*');
                    } catch (e) {}
                    return;
                }
                const values = getValues();
                emit('emr:submitted', { values });
                try {
                    window.postMessage({ namespace: 'emr', type: 'submitted', payload: { values } }, '*');
                } catch (e) {}
            });
        }

        const downloadPdfBtn = qs('#download_pdf');
        if (downloadPdfBtn) {
            downloadPdfBtn.addEventListener('click', () => {
                const patientName = qs('#patient_search')?.value || 'Unknown';
                const patientId = qs('#patient_id')?.value || 'Unknown';
                const sessionDate = qs('#session_date')?.value || new Date().toISOString().split('T')[0];

                const filename = `EMR_${patientId}_${sessionDate}.pdf`;

                alert(`PDF Download:\n\nFilename: ${filename}\n\nNote: Use your browser's Print > Save as PDF option to generate the PDF.`);
                window.print();
            });
        }

        // Expose API
        window.EmrDashboard = {
            getSchema,
            getValues,
            setValues,
            click,
            validate,
            version: manifest.version
        };

        // postMessage bridge
        window.addEventListener('message', (evt) => {
            const msg = evt.data;
            if (!msg || msg.namespace !== 'emr') return;

            if (msg.type === 'getSchema') {
                evt.source && evt.source.postMessage({ namespace: 'emr', type: 'schema', payload: getSchema() }, '*');
            } else if (msg.type === 'getValues') {
                evt.source && evt.source.postMessage({ namespace: 'emr', type: 'values', payload: getValues() }, '*');
            } else if (msg.type === 'setValues') {
                setValues(msg.payload || {});
                evt.source && evt.source.postMessage({ namespace: 'emr', type: 'ack', op: 'setValues' }, '*');
            } else if (msg.type === 'click') {
                click(msg.payload);
                evt.source && evt.source.postMessage({ namespace: 'emr', type: 'ack', op: 'click' }, '*');
            } else if (msg.type === 'validate') {
                evt.source && evt.source.postMessage({ namespace: 'emr', type: 'validation', payload: validate() }, '*');
            }
        });

        // Ready notifications
        emit('emr:ready', { version: manifest.version, name: manifest.name });
        try {
            window.postMessage({ namespace: 'emr', type: 'ready', payload: { version: manifest.version, name: manifest.name } }, '*');
        } catch (e) {}
    })();
    </script>
</body>
</html>
